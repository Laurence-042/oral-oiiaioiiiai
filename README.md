# ğŸ± OIIAIOIIIAI â€” é­”æ€§å‘å£°éŸ³æ¸¸

> å¯¹ç€éº¦å…‹é£å‘å‡º "oiiaioiiiai"ï¼Œè®©çŒ«å’ªç–¯ç‹‚æ—‹è½¬ï¼

ä¸€ä¸ªåŸºäºå®æ—¶å…ƒéŸ³è¯†åˆ«çš„æµè§ˆå™¨éŸ³æ¸¸ã€‚ç©å®¶å¯¹ç€éº¦å…‹é£è¿ç»­å‘å‡º O / I / A å…ƒéŸ³ï¼Œé©±åŠ¨çŒ«å’ªæ—‹è½¬å¹¶è§¦å‘äº”é˜¶æ®µè§†è§‰è¿›åŒ–ã€‚çµæ„Ÿæ¥è‡ªé‚£åªä¸€è¾¹æ—‹è½¬ä¸€è¾¹å‘å‡ºé­”æ€§å£°éŸ³çš„çŒ« ğŸ±ğŸ”„

**[â–¶ï¸ åœ¨çº¿è¯•ç©](https://laurence-042.github.io/project/oral-oiiaioiiiai/demo/)** ï½œ [è®¾è®¡æ–‡æ¡£](story.md) ï½œ [ML æ£€æµ‹å™¨æ–‡æ¡£ä¸é¡¹ç›®ç»†èŠ‚](src/composables/VOWEL_DETECTOR_ML.md)

oiia ç´ ææ¥æºï¼šhttps://www.bilibili.com/video/BV1AvLizFEPn/

[TOC]

## ç‰¹æ€§

- ğŸ¤ **å®æ—¶å…ƒéŸ³è¯†åˆ«** â€” TensorFlow.js CNN æ¨¡å‹ï¼Œæµè§ˆå™¨ç«¯æ¨ç†
- ğŸ¯ **åºåˆ—æ ¡éªŒ** â€” æ£€æµ‹ Oâ†’Iâ†’Iâ†’Aâ†’Iâ†’Oâ†’Iâ†’Iâ†’Iâ†’Aâ†’I å¾ªç¯ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é… (Uâ†”O, Iâ†”E)
- ğŸ”¥ **äº”é˜¶æ®µè§†è§‰è¿›åŒ–** â€” ä»ç¼“æ…¢æ—‹è½¬åˆ°å…¨å±å½©è™¹æ¼©æ¶¡ï¼Œç²’å­ / è‰²å·® / æ®‹å½± / å±å¹•æŠ–åŠ¨
- ğŸµ **ç¨‹åºåŒ– BGM** â€” Tone.js 8 è½¨é“é€é˜¶æ®µå åŠ ï¼ŒBPM è·Ÿéšå‘éŸ³é€Ÿåº¦
- ğŸ“¸ **åˆ†äº«ç³»ç»Ÿ** â€” ç»“ç®—å¡ç‰‡ + é«˜å…‰æ—¶åˆ» + QR ç ï¼Œæ‰‡å½¢å¡ç‰‡è½®æ’­
- ğŸ† **å…¨ç½‘æ’è¡Œæ¦œ** â€” Cloudflare Workers KV åç«¯
- ğŸ“¦ **èµ„æºåŒ…ç³»ç»Ÿ** â€” å¯æ›¿æ¢çŒ«å’ªå¸§åŠ¨ç”»ã€éŸ³èŠ‚éŸ³æ•ˆã€é˜¶æ®µæ–‡æ¡ˆ

## å¿«é€Ÿå¼€å§‹

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (https://localhost:3000)
npm run dev

# ç”Ÿäº§æ„å»º
npm run build

# ä»…ç±»å‹æ£€æŸ¥
npx tsc --noEmit
```

> âš ï¸ éº¦å…‹é£ API éœ€è¦ HTTPS æˆ– localhostã€‚å¼€å‘æœåŠ¡å™¨å·²é…ç½®è‡ªç­¾å SSLã€‚

## æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| å‰ç«¯æ¡†æ¶ | Vue 3 + TypeScript (Composition API) |
| æ„å»ºå·¥å…· | Vite 5 |
| å…ƒéŸ³è¯†åˆ« | TensorFlow.js CNN / MFCC å…±æŒ¯å³°åŒæ¨¡å¼ |
| éŸ³é¢‘å¤„ç† | Web Audio API (AudioWorklet, 16kHz é‡é‡‡æ ·) |
| åŠ¨æ€éŸ³ä¹ | Tone.js ç¨‹åºåŒ–åˆæˆ |
| è§†è§‰ç‰¹æ•ˆ | CSS + Canvas 2D ç²’å­ç³»ç»Ÿ |
| æ’è¡Œæ¦œåç«¯ | Cloudflare Workers + KV |
| åˆ†äº«å›¾ç”Ÿæˆ | Canvas 2D + qrcode åº“ |

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ composables/                   # ä¸šåŠ¡é€»è¾‘ (Vue 3 Composition API)
â”‚   â”œâ”€â”€ useVowelDetectorML.ts      # â­ CNN å…ƒéŸ³æ£€æµ‹å™¨
â”‚   â”œâ”€â”€ useVowelDetector.ts        # FFT å…±æŒ¯å³°åå¤‡æ£€æµ‹å™¨
â”‚   â”œâ”€â”€ useGameState.ts            # æ¸¸æˆçŠ¶æ€æœºï¼ˆè®¡åˆ†/è¿å‡»/é˜¶æ®µï¼‰
â”‚   â”œâ”€â”€ useDynamicBGM.ts           # ç¨‹åºåŒ– BGM ç”Ÿæˆ
â”‚   â”œâ”€â”€ useResourcePack.ts         # èµ„æºåŒ…åŠ è½½ä¸ç®¡ç†
â”‚   â”œâ”€â”€ useHighlights.ts           # é«˜å…‰æ—¶åˆ»æ•è·
â”‚   â”œâ”€â”€ useHighlightRenderer.ts    # é«˜å…‰å¡ç‰‡ Canvas æ¸²æŸ“
â”‚   â”œâ”€â”€ useShareCapture.ts         # åˆ†äº«æˆªå›¾ç”Ÿæˆ
â”‚   â””â”€â”€ useLeaderboard.ts          # æ’è¡Œæ¦œ API äº¤äº’
â”œâ”€â”€ components/
â”‚   â””â”€â”€ CardFan.vue                # æ‰‡å½¢å¡ç‰‡è½®æ’­ç»„ä»¶
â”œâ”€â”€ views/
â”‚   â”œâ”€â”€ GameView.vue               # ä¸»æ¸¸æˆé¡µé¢
â”‚   â”œâ”€â”€ DebugView.vue              # å…ƒéŸ³è¯†åˆ«è°ƒè¯•ï¼ˆCNN/MFCC åˆ‡æ¢ï¼‰
â”‚   â”œâ”€â”€ AudioAnalyzer.vue          # ç¦»çº¿éŸ³é¢‘åˆ†æå·¥å…·
â”‚   â””â”€â”€ MediaProcessor.vue         # èµ„æºåŒ…ç´ æåŠ å·¥å·¥å…·
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ stages.ts                  # 5 é˜¶æ®µè§†è§‰é…ç½®
â”‚   â””â”€â”€ vowels.ts                  # å…ƒéŸ³åºåˆ— & å…±æŒ¯å³°å‚æ•°
â”œâ”€â”€ types/
â”‚   â””â”€â”€ game.ts                    # æ‰€æœ‰ TypeScript æ¥å£
â””â”€â”€ router/index.ts

public/
â”œâ”€â”€ models/vowel/                  # TF.js æ¨¡å‹æ–‡ä»¶
â”‚   â”œâ”€â”€ model.json                 # æ¨¡å‹æ¶æ„ (37KB)
â”‚   â””â”€â”€ group1-shard1of1.bin       # é‡åŒ–æƒé‡ (69KB)
â””â”€â”€ resources/                     # èµ„æºåŒ…
    â””â”€â”€ oiia/                      # é»˜è®¤èµ„æºåŒ…

worker/                            # æ’è¡Œæ¦œ Cloudflare Worker
```

## ç©æ³•

### å‘å£° â†’ è¯†åˆ« â†’ åé¦ˆ

```
éº¦å…‹é£ â†’ AudioContext â†’ 16kHz é‡é‡‡æ · â†’ CNN æ¨ç† â†’ å…ƒéŸ³åºåˆ—æ ¡éªŒ
                                                        â†“
               UI æ›´æ–° â† é˜¶æ®µè§†è§‰å‡çº§ â† è®¡åˆ†ç³»ç»Ÿ â† åŒ¹é…ç»“æœ
```

### è®¡åˆ†è§„åˆ™

| è§„åˆ™ | æ•°å€¼ |
|------|------|
| æ­£ç¡®å…ƒéŸ³ | +10 åˆ† |
| è¿å‡»å€ç‡ | æ¯ 10 è¿å‡» +10%ï¼Œæœ€é«˜ 3x |
| é€Ÿåº¦åŠ æˆ | é—´éš” <300ms é¢å¤– +5 |
| å®Œç¾å¾ªç¯ | å®Œæ•´ oiiaioiiiai é¢å¤– +50 |

### è§†è§‰é˜¶æ®µ

| é˜¶æ®µ | åˆ†æ•° | æ•ˆæœ |
|------|------|------|
| åˆé†’ | 0 | ç¼“æ…¢æ—‹è½¬ |
| èºåŠ¨ | 500 | åŠ é€Ÿ + ç²’å­ |
| ç‹‚çƒ­ | 2,000 | éœ“è™¹ + å±å¹•æŠ–åŠ¨ |
| è¶…åº¦ | 5,000 | æ®‹å½± + è¿·å¹»èƒŒæ™¯ |
| ç¥çŒ« | 10,000 | å…¨å±å½©è™¹æ¼©æ¶¡ |

## å¼€å‘è¯´æ˜

### è·¯ç”±

| è·¯å¾„ | è¯´æ˜ |
|------|------|
| `/game` | ä¸»æ¸¸æˆï¼ˆé»˜è®¤ï¼‰ï¼Œæ”¯æŒ CNN/MFCC æ£€æµ‹å™¨åˆ‡æ¢ |
| `/debug` | å®æ—¶å…ƒéŸ³è¯†åˆ«è°ƒè¯•ï¼Œå¯åˆ‡æ¢ CNN/MFCCï¼ŒæŸ¥çœ‹æ¦‚ç‡åˆ†å¸ƒä¸å»¶è¿Ÿ |
| `/analyzer` | ç¦»çº¿éŸ³é¢‘åˆ†æï¼ŒåŠ è½½æ–‡ä»¶æˆ–å½•éŸ³æŸ¥çœ‹é¢‘è°±/å…±æŒ¯å³°ç‰¹å¾ |
| `/media-processor` | èµ„æºåŒ…ç´ æåŠ å·¥ï¼Œä»è§†é¢‘ä¸­æå–éŸ³èŠ‚éŸ³é¢‘å’Œå¸§åŠ¨ç”» |

### èµ„æºåŒ…ç³»ç»Ÿ

èµ„æºåŒ…æ˜¯æ¸¸æˆå†…å®¹çš„æ ¸å¿ƒè½½ä½“ï¼Œå®šä¹‰äº†è§’è‰²åŠ¨ç”»ã€éŸ³èŠ‚éŸ³æ•ˆã€BGMã€é˜¶æ®µæ–‡æ¡ˆç­‰ã€‚å­˜æ”¾äº `public/resources/<pack-id>/`ã€‚

#### ç›®å½•ç»“æ„

```
public/resources/
â”œâ”€â”€ index.json                     # èµ„æºåŒ…æ³¨å†Œè¡¨ { "packs": ["oiia", ...] }
â””â”€â”€ <pack-id>/
    â”œâ”€â”€ manifest.json              # å¿…éœ€ â€” åŒ…å…ƒæ•°æ®ã€èµ„äº§æ¸…å•
    â”œâ”€â”€ bgm.json                   # å¯é€‰ â€” Tone.js ç¨‹åºåŒ– BGM é…ç½®
    â”œâ”€â”€ syllables/                 # éŸ³èŠ‚éŸ³é¢‘
    â”‚   â”œâ”€â”€ 001_U.wav              # å‘½åï¼š<3ä½åºå·>_<å…ƒéŸ³>.wav
    â”‚   â”œâ”€â”€ 002_I.wav
    â”‚   â””â”€â”€ ...
    â””â”€â”€ chroma_frames/             # è§’è‰²å¸§åŠ¨ç”»ï¼ˆè‰²åº¦é”® PNGï¼‰
        â”œâ”€â”€ chroma_001.png         # ç¬¬ 1 å¸§ = é™æ­¢å¾…æœºå¸§
        â”œâ”€â”€ chroma_002.png         # å…¶ä½™å¸§ = åŠ¨ç”»å¾ªç¯
        â””â”€â”€ ...
```

#### manifest.json

```jsonc
{
  "id": "oiia",                          // å”¯ä¸€æ ‡è¯†ï¼Œä¸ç›®å½•åä¸€è‡´
  "name": "OIIA Cat",                     // æ˜¾ç¤ºåç§°
  "description": "ç»å…¸æ—‹è½¬çŒ«",             // ç®€çŸ­æè¿°
  "sequence": ["U","I","I","A",...],      // ç›®æ ‡å…ƒéŸ³åºåˆ—
  "syllables": ["001_U.wav", ...],        // éŸ³èŠ‚æ–‡ä»¶åˆ—è¡¨ï¼ˆæœ‰åºï¼‰
  "chromaFrames": ["chroma_001.png",...],  // å¸§åŠ¨ç”»æ–‡ä»¶åˆ—è¡¨ï¼ˆæœ‰åºï¼‰
  "bgm": "bgm.json",                      // å¯é€‰ï¼ŒBGM é…ç½®æ–‡ä»¶å
  "textConfig": {                          // å¯é€‰ï¼Œæ–‡æ¡ˆé…ç½®ï¼ˆçœç•¥åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
    "stages": [
      { "name": "åˆé†’", "scoreThreshold": 0,
        "copywriting": [{"title": "...", "subtitle": "..."}] },
      // ... å…¶ä½™é˜¶æ®µ
    ],
    "highlightLabels": {
      "stage-up": "â¬† {stageName}",
      "combo-milestone": "ğŸ”¥ {combo} è¿å‡»",
      "perfect-cycle": "âœ¨ å®Œç¾å¾ªç¯ Ã—{count}",
      "speed-burst": "âš¡ æé€Ÿ {speed}/s",
      "accuracy-streak": "ğŸ¯ ç²¾å‡† Ã—{count}",
      "final": "ğŸ æœ€ç»ˆæ—¶åˆ»"
    },
    "leaderboardText": { "unit": "çŒ«å«", "participateVerb": "å‚ä¸" }
  }
}
```

#### bgm.json

æ•°æ®é©±åŠ¨çš„åˆæˆå™¨ BGM é…ç½®ï¼Œæ¯ä¸ªè½¨é“æŒ‡å®š Tone.js åˆæˆå™¨ç±»å‹ã€éŸ³ç¬¦åºåˆ—å’Œç”Ÿæ•ˆé˜¶æ®µï¼š

```jsonc
{
  "baseBPM": 120,
  "bpmRange": [60, 240],
  "masterVolume": -8,
  "tracks": [
    {
      "id": "kick",
      "synth": "membrane",          // membrane | metal | noise | mono | fm | am | duo
      "options": { ... },            // Tone.js åˆæˆå™¨å‚æ•°
      "effects": [{"type":"reverb"}], // å¯é€‰æ•ˆæœå™¨é“¾
      "volume": -6,
      "pattern": ["C1", null, null, null],  // éŸ³ç¬¦åºåˆ—ï¼Œnull=ä¼‘æ­¢
      "subdivision": "4n",
      "stages": [1, 2, 3, 4, 5],     // åœ¨å“ªäº›é˜¶æ®µå¯ç”¨
      "stageVolumes": { "1": -12 }   // å¯é€‰çš„é€é˜¶æ®µéŸ³é‡è¦†ç›–
    }
    // ... æ›´å¤šè½¨é“
  ]
}
```

è½¨é“æŒ‰é˜¶æ®µé€å±‚å å…¥ï¼šä½é˜¶æ®µåªæœ‰èŠ‚å¥åŸºåº•ï¼Œé«˜é˜¶æ®µåŠ å…¥æ—‹å¾‹å’Œ padï¼Œè¥é€ é€’è¿›æ„Ÿã€‚

#### åˆ›å»ºæ–°èµ„æºåŒ…

1. **å‡†å¤‡ç´ æè§†é¢‘** â€” åŒ…å«è§’è‰²å¾ªç¯åŠ¨ç”»å’Œé…éŸ³çš„ MP4
2. **ä½¿ç”¨ç´ æåŠ å·¥å·¥å…·** â€” è®¿é—® `/media-processor`ï¼Œå¯¼å…¥è§†é¢‘ï¼ŒæŒ‰é™éŸ³ç‚¹è‡ªåŠ¨åˆ‡åˆ†éŸ³èŠ‚ï¼Œæå–å¸§åŠ¨ç”»
3. **ç¼–å†™ manifest.json** â€” å¡«å†™åºåˆ—ã€æ–‡ä»¶åˆ—è¡¨ã€é˜¶æ®µæ–‡æ¡ˆ
4. **ï¼ˆå¯é€‰ï¼‰ç¼–å†™ bgm.json** â€” å®šä¹‰åˆæˆå™¨è½¨é“å’ŒéŸ³ç¬¦åºåˆ—
5. **æ³¨å†Œèµ„æºåŒ…** â€” å°† `pack-id` æ·»åŠ åˆ° `public/resources/index.json` çš„ `packs` æ•°ç»„
6. åˆ·æ–°é¡µé¢ï¼Œåœ¨æ¸¸æˆå³ä¸Šè§’ä¸‹æ‹‰é€‰æ‹©æ–°èµ„æºåŒ…

### ML æ¨¡å‹

å½“å‰æ¨¡å‹åŸºäº Kaggle ç‹¬ç«‹å…ƒéŸ³æ•°æ®é›†è®­ç»ƒã€‚æ¸¸æˆåŒæ—¶æä¾› CNN å’Œ MFCC ä¸¤ç§æ£€æµ‹å™¨ï¼Œé»˜è®¤ä½¿ç”¨ MFCCï¼ˆå»¶è¿Ÿæ›´ä½ï¼‰ã€‚è¯¦è§ [ML æ£€æµ‹å™¨æ–‡æ¡£](src/composables/VOWEL_DETECTOR_ML.md)ã€‚è®­ç»ƒç¬”è®°æœ¬ä½äº [model/](model/) ç›®å½•ã€‚

## äºŒæ¬¡å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰èµ„æºåŒ…

æœ€ç®€å•çš„æ‰©å±•æ–¹å¼ â€” ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç ï¼š

1. åœ¨ `public/resources/` ä¸‹æ–°å»ºç›®å½•
2. æ”¾å…¥éŸ³èŠ‚éŸ³é¢‘ï¼ˆWAVï¼‰ã€å¸§åŠ¨ç”»ï¼ˆPNGï¼‰ã€manifest.json
3. åœ¨ `index.json` æ³¨å†Œ
4. å®Œæˆï¼Œæ¸¸æˆä¼šè‡ªåŠ¨åœ¨ç•Œé¢æä¾›åˆ‡æ¢é€‰é¡¹

### ä¿®æ”¹æ¸¸æˆæœºåˆ¶

- **è®¡åˆ†è§„åˆ™** â€” `src/composables/useGameState.ts`ï¼Œä¿®æ”¹ `handleVowel()` ä¸­çš„åˆ†æ•°è®¡ç®—
- **é˜¶æ®µé˜ˆå€¼** â€” ç”±èµ„æºåŒ… `manifest.json` çš„ `textConfig.stages[].scoreThreshold` å®šä¹‰ï¼Œä¹Ÿå¯åœ¨ `src/config/stages.ts` ä¿®æ”¹é»˜è®¤å€¼
- **å…ƒéŸ³åºåˆ—** â€” ç”±èµ„æºåŒ… `manifest.json` çš„ `sequence` å­—æ®µå®šä¹‰
- **ä¸­æ–­æ¡ä»¶** â€” `useGameState.ts` ä¸­çš„ `silenceTimeout`ï¼ˆé™éŸ³è¶…æ—¶ï¼‰å’Œ `maxConsecutiveErrors`ï¼ˆè¿ç»­é”™è¯¯ï¼‰

### ä¿®æ”¹è§†è§‰æ•ˆæœ

- **é˜¶æ®µè§†è§‰é…ç½®** â€” `src/config/stages.ts` ä¸­çš„ `StageVisualConfig`ï¼ˆæ—‹è½¬é€Ÿåº¦ã€ç²’å­ã€è‰²å·®ã€å±å¹•æŠ–åŠ¨ç­‰ï¼‰
- **ä¸»æ¸¸æˆ UI** â€” `src/views/GameView.vue`ï¼ˆCSS + æ¨¡æ¿ï¼‰
- **åˆ†äº«å¡ç‰‡æ ·å¼** â€” `src/composables/useShareCapture.ts` å’Œ `useHighlightRenderer.ts`ï¼ˆCanvas ç»˜åˆ¶ï¼‰

### æ”¹è¿›å…ƒéŸ³æ£€æµ‹

- **CNN æ¨¡å‹** â€” é‡æ–°è®­ç»ƒå¹¶æ›¿æ¢ `public/models/vowel/` ä¸‹çš„æ¨¡å‹æ–‡ä»¶ï¼Œä¿æŒè¾“å…¥æ ¼å¼ (3360 samples @ 16kHz) å’Œè¾“å‡ºæ ¼å¼ (6 ç±» softmax) ä¸å˜
- **MFCC å‚æ•°** â€” `src/config/vowels.ts` ä¸­è°ƒæ•´å…±æŒ¯å³°é¢‘ç‡èŒƒå›´
- **AudioWorklet** â€” `src/workers/vowelAudioProcessor.ts` ä¸­è°ƒæ•´é‡é‡‡æ ·å’Œç¼“å†²ç­–ç•¥
- **è°ƒè¯•** â€” `/debug` é¡µå®æ—¶å¯¹æ¯”ä¸¤ç§æ£€æµ‹å™¨ï¼Œ`/analyzer` é¡µç¦»çº¿åˆ†æéŸ³é¢‘ç‰¹å¾

### æ’è¡Œæ¦œåç«¯

ç‹¬ç«‹çš„ Cloudflare Workerï¼Œä½äº `worker/` ç›®å½•ã€‚å‰ç«¯é€šè¿‡ç¯å¢ƒå˜é‡ `VITE_LEADERBOARD_API` é…ç½® API åœ°å€ã€‚ä¸é…ç½®åˆ™æ’è¡Œæ¦œåŠŸèƒ½è‡ªåŠ¨éšè—ã€‚

```bash
cd worker
npm install
npm run dev      # æœ¬åœ°å¼€å‘ â†’ http://localhost:8787
npm run deploy   # éƒ¨ç½²åˆ° Cloudflare
```

## License

[MPL-2.0](LICENSE)