# OIIAIOIIIAI - 魔性发声音游

> 🐱 对着猫叫，成为传说

## 项目背景

### 灵感来源

《Friday Night Funkin'》挺流行的，其中角色唱歌不是真的歌词，而是那种魔性的"哔啵哔啵"的电子合成音。

这让我开始寻思，能不能把这个玩法反过来，即让玩家发出魔性的声音的音游。

### 技术挑战与解决思路

我进一步寻思玩家发出 A/I/U/E/O 的元音来操作的技术可行性，随后意识到这作为音游有不少不兼容：

| 挑战 | 问题描述 | 解决方案 |
|------|----------|----------|
| **延迟** | 音游对节奏要求极高（通常在 10ms 级）。处理音频、进行 FFT 变换再到判断元音，往往会有几十毫秒的延迟，"不跟手"感明显 | 放弃反应式音游，改为**执行特定序列的操作式音游** |
| **方言与口音** | 不同地区的"a"发音共振峰有差异，针对标准日语优化的模型可能识别不出其他口音 | 选择**全球通用的 oiiaioiiiai 发音**，简化为 O/I/A 三个元音 |
| **社交尴尬** | 对着设备大喊限制了游玩场景 | 反向利用：**足够魔性反而有利于社交媒体传播** |

### 最终方案

**oiiaioiiiai** —— 那只一边旋转一边发出魔性声音的猫 🐱🔄

这个方案完美解决了上述问题：
- ✅ 不需要精确节奏判定，只需检测连续发音
- ✅ O/I/A 三个元音全球通用，共振峰差异明显易于区分
- ✅ 自带病毒式传播属性

---

## 核心玩法

### 基本机制

```
玩家发声 → 元音识别 → 猫咪旋转 → 积分累计 → 视觉升级
    ↑                                           |
    └───────────── 反馈循环 ←──────────────────┘
```

1. **发声检测**：玩家连续发出 "oiiaioiiiai" 的声音
2. **元音识别**：识别 O → I → I → A → I → O → I → I → I → A → I 的循环
3. **连击计算**：正确发音累计连击，错误或停顿则重置
4. **动态反馈**：猫咪旋转速度、动效强度随连击数提升

### 分数系统

| 指标 | 计算方式 | 说明 |
|------|----------|------|
| **基础分** | 每次正确发音 +10 分 | 识别到正确元音即得分 |
| **连击倍率** | `1 + floor(combo / 10) * 0.1` | 每 10 连击提升 10% 倍率，最高 3x |
| **速度加成** | 发音间隔 < 300ms 时额外 +5 分 | 鼓励快速连续发音 |
| **完美循环** | 完整发出一次 "oiiaioiiiai" 额外 +50 分 | 11 个音节完整循环 |

### 视觉进化阶段

> 💡 按分数触发，一轮完整的 "oiiaioiiiai" 约得 200-250 分

| 阶段 | 触发分数 | 大约所需轮数 | 视觉效果 |
|------|----------|--------------|----------|
| **Stage 1: 初醒** | 0 分 | 开局 | 猫咪缓慢旋转，基础背景 |
| **Stage 2: 躁动** | 500 分 | ~2 轮 | 旋转加速，粒子特效出现 |
| **Stage 3: 狂热** | 2,000 分 | ~8 轮 | 霓虹光效，屏幕轻微抖动 |
| **Stage 4: 超度** | 5,000 分 | ~20 轮 | 分身残影，迷幻背景 |
| **Stage 5: 神猫** | 10,000 分 | ~40 轮 | 全屏特效爆发，彩虹漩涡 |

*注：以正常语速（约 3 秒/轮）计算，Stage 5 约需 2 分钟持续发声*

### 中断与重来

- **静音超时**：超过 1.5 秒无有效发音 → 连击中断
- **错误元音**：连续 3 次错误 → 连击中断
- **中断动画**：猫咪"晕倒"动画 + 屏幕渐暗
- **快速重来**：任意发声即可重新开始

---

## 分享系统

### 中断时的分享激励

当连击中断时，根据成绩展示不同的分享选项：

#### 1. 截图分享（默认）
- 自动生成带有以下元素的图片：
  - 猫咪当前状态截图
  - 分数与连击数
  - 二维码（指向游戏网站）
  - 文案示例：
    - "我的 OIIIA 完成度 **99%**" 
    - "我让猫转了 **666** 圈！"
    - "我是 **神猫** 级别的 OIIIA 大师！"

#### 2. 视频录制导出
- 录制最后 15-30 秒的游玩过程
- 包含玩家的真实声音（可选）
- 自动添加水印和结尾动画
- 导出为 MP4（保留声音才有灵魂！）

#### 3. 全网排行榜
- 输入昵称上传分数
- 使用 Cloudflare Workers KV 存储
- 花哨的排行榜展示：
  ```
  🏆 全网合唱排行榜 🏆
  
  今日已有 5,000 人对着猫叫
  累计 OIIIA 次数：1,234,567
  
  👑 第一名：猫王·究极体 - 99,999 分
  🥈 第二名：深夜の猫叫兽 - 88,888 分
  🥉 第三名：OIIIA传道士 - 77,777 分
  ```

#### 4. 自定义BGM模式（进阶功能）
- 上传一段音乐作为背景
- 猫咪旋转节奏与音乐 BPM 关联
- 生成"对口型"效果的混剪视频

---

## 自由模式（创作者工具）

> 🎬 为想要 DIY 视频的玩家提供完全控制权

### 可调参数

| 参数 | 说明 | 默认值 | 自由模式范围 |
|------|------|--------|--------------|
| **当前阶段** | 手动锁定视觉阶段 | 自动 | Stage 1-5 任选 |
| **停顿阈值** | 多久无声才算中断 | 1.5 秒 | 0.5 - 10 秒 / 关闭 |
| **序列模式** | 是否要求固定顺序 | 固定 (oiiaioiiiai) | 固定 / 任意元音 |
| **旋转速度** | 猫咪基础旋转速度 | 随发音 | 手动 0-500% |
| **特效强度** | 粒子/光效密度 | 随阶段 | 手动 0-200% |
| **背景样式** | 背景视觉效果 | 随阶段 | 任意阶段背景 |

### 使用场景

- **录制素材**：锁定 Stage 5 + 关闭中断，尽情录制魔性片段
- **配音创作**：关闭序列限制，用任意元音触发动画
- **节奏控制**：调高停顿阈值，按自己的节奏表演
- **纯展示**：手动控制旋转速度，不依赖语音输入

### 入口

- 主界面设置按钮 → 自由模式开关
- 开启后显示参数调节面板（可折叠）
- 自由模式下分数不计入排行榜（防作弊）

---

## 彩蛋系统

### 意外触发

| 触发条件 | 彩蛋效果 | 说明 |
|----------|----------|------|
| **惨叫/尖叫** | 猫变成大叫的土拨鼠 | 检测到非 O/I/A 的高频持续音 |
| **打嗝/咳嗽** | 猫咪被"吓到"弹飞 | 检测到突发短促的气流声 |
| **吹口哨** | 猫咪开始跟着旋律摇摆 | 检测到持续的高频纯音 |
| **静默 10 秒** | 猫咪睡着打呼噜 | 长时间无输入 |
| **连续错误** | 猫咪露出困惑表情 | 识别到元音但顺序完全错误 |

### 隐藏成就

- 🏅 **午夜猫叫**：在 00:00-06:00 游玩
- 🏅 **完美主义者**：连续 100 次不出错
- 🏅 **速度之猫**：平均发音间隔 < 200ms 持续 30 秒
- 🏅 **马拉松选手**：单次游戏超过 5 分钟
- 🏅 **社交达猫**：分享到社交媒体

---

## 技术实现

### 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **前端框架** | Vue 3 + TypeScript | Composition API，类型安全 |
| **构建工具** | Vite | 快速开发，HMR |
| **音频处理** | Essentia.js / Meyda.js | 实时 FFT + 元音共振峰分析 |
| **动画引擎** | GSAP / Lottie | 高性能动画 + 预制动效 |
| **视觉特效** | PixiJS / Three.js（可选） | 粒子系统、着色器效果 |
| **录制功能** | MediaRecorder API | 浏览器原生录屏 |
| **后端服务** | Cloudflare Workers + KV | 排行榜存储，Serverless |

### 元音识别方案

```
麦克风输入 → 采样 (44.1kHz) → 分帧 (50ms) → FFT → 共振峰提取 → 元音分类
```

**共振峰特征（Hz 参考值）**：

| 元音 | F1 (第一共振峰) | F2 (第二共振峰) | 特征 |
|------|-----------------|-----------------|------|
| O | 400-600 | 800-1200 | F1/F2 都较低 |
| I | 200-400 | 2000-3000 | F1 低，F2 高 |
| A | 700-1000 | 1200-1800 | F1 高，F2 中等 |

**容错策略**：
- 使用 K-Nearest Neighbors 或简单阈值判定
- 设置"模糊区间"，避免边界误判
- 连续 2 帧相同结果才确认元音切换
- **ML 滤波（Schmitt 触发）**：高阈值进入、低阈值退出，并设置切换 margin，降低概率抖动
- **模糊元音**：U↔O、I↔E 互认，减少口型接近导致的误判
- **错误计数防抖**：短时间内的抖动不重复计错，避免连续 3 次错误过于严格

### 项目结构

```
src/
├── assets/                 # 静态资源
│   ├── images/            # 猫咪图片、背景等
│   ├── audio/             # 音效、BGM
│   └── animations/        # Lottie 动画文件
├── components/
│   ├── CatSpinner.vue     # 核心猫咪旋转组件
│   ├── ScoreBoard.vue     # 分数显示
│   ├── VisualEffects.vue  # 特效层
│   ├── ShareModal.vue     # 分享弹窗
│   └── Leaderboard.vue    # 排行榜
├── composables/
│   ├── useAudioAnalyzer.ts    # 音频分析 Hook
│   ├── useVowelDetector.ts    # 元音检测 Hook
│   ├── useGameState.ts        # 游戏状态管理
│   └── useRecorder.ts         # 录制功能 Hook
├── config/
│   ├── stages.ts          # 阶段配置（动画、特效、BGM）
│   ├── vowels.ts          # 元音识别参数
│   └── achievements.ts    # 成就配置
├── utils/
│   ├── fft.ts             # FFT 工具函数
│   └── formant.ts         # 共振峰计算
├── views/
│   ├── GameView.vue       # 主游戏页面
│   └── LeaderboardView.vue# 排行榜页面
├── App.vue
└── main.ts
```

### 配置化设计

所有视觉效果通过配置文件定义，便于后续扩展：

```typescript
// config/stages.ts
interface StageConfig {
  id: number;
  name: string;
  comboThreshold: number;
  cat: {
    rotationSpeed: number;      // 旋转速度 (deg/s)
    scale: number;              // 缩放
    trailEffect: boolean;       // 残影效果
    sprite?: string;            // 可选替换图片
  };
  background: {
    color: string;
    particles: ParticleConfig;
    shader?: string;
  };
  audio: {
    bgm?: string;
    sfxPitch: number;           // 音效变调
  };
  screenEffects: {
    shake: number;              // 抖动强度
    vignette: number;           // 暗角
    chromatic: number;          // 色差
  };
}
```

---

## 开发路线图

### Phase 1: MVP（2 周）
- [ ] 基础音频采集与元音识别
- [ ] 猫咪旋转动画
- [ ] 分数计算与显示
- [ ] 单一视觉阶段

### Phase 2: 完整体验（2 周）
- [ ] 5 个视觉进化阶段
- [ ] 粒子特效系统
- [ ] 截图分享功能
- [ ] 本地排行榜

### Phase 3: 社交功能（1 周）
- [ ] Cloudflare Workers 后端
- [ ] 全网排行榜
- [ ] 视频录制导出

### Phase 4: 润色与彩蛋（1 周）
- [ ] 彩蛋系统
- [ ] 成就系统
- [ ] 音效优化
- [ ] 移动端适配

---

## 注意事项

### 性能优化
- 音频处理使用 Web Worker 避免阻塞主线程
- 动画使用 `requestAnimationFrame` 与 GPU 加速
- 粒子系统限制最大数量

### 兼容性
- 需要 HTTPS 以使用麦克风 API
- 提供"无麦克风"演示模式（键盘输入模拟）
- iOS Safari 需要用户手势触发音频

### 隐私
- 声音数据仅本地处理，不上传服务器
- 排行榜仅存储昵称和分数
- 明确的麦克风权限请求提示

---

## 实现进度 Checklist

> 最后更新：2026-02-09

### 核心玩法

- [x] 元音检测 — CNN ML 模型 (`useVowelDetectorML`)
- [x] 元音检测 — FFT 共振峰后备 (`useVowelDetector`)
- [x] 检测器切换 UI（CNN / MFCC）
- [x] 序列校验 (oiiaioiiiai 循环)
- [x] 模糊匹配 (U↔O, I↔E)
- [x] 错误计数防抖 (`errorDebounceMs`)
- [x] 首次发音前不计静音超时 (`hasFirstVowel` 门控)

### 计分系统

- [x] 基础分 +10
- [x] 连击倍率 `1 + floor(combo/10) * 0.1`，max 3x
- [x] 速度加成 (<300ms → +5)
- [x] 完美循环奖励 +50
- [x] 分数 / 连击 / 阶段 / 循环 UI 显示

### 视觉阶段系统

- [x] 5 阶段分数阈值 (0 / 500 / 2000 / 5000 / 10000)
- [x] 阶段切换回调 (`onStageChange`)
- [x] 猫旋转速度按阶段变化
- [x] 猫缩放按阶段变化
- [x] 5 阶段完整配置数据 (粒子/shake/vignette/chromatic/trail/背景)
- [x] 背景渐变按阶段变化
- [x] 粒子特效渲染 — *Canvas 2D 粒子系统*
- [x] 屏幕抖动 (shake)
- [x] 暗角 (vignette)
- [x] 色差 (chromatic aberration) — *drop-shadow 偏移模拟*
- [x] 残影/分身 (trail)
- [x] Stage 5 彩虹漩涡 — *conic-gradient 背景*
- [x] 阶段 BGM — *Tone.js 程序化生成，8 轨道逐阶段叠加，BPM 跟随玩家速度，资源包 `bgm.json` 配置*
- [x] SFX 变调 (`sfxPitch`) — *`playSyllable` 设置 `playbackRate`*

### 中断与重来

- [x] 静音超时 1.5s
- [x] 连续 3 次错误中断
- [x] 手动暂停
- [x] 结算卡片（分数/连击/阶段/循环/时长）
- [x] 猫咪"晕倒"动画 + 屏幕渐暗 — *CSS faint-fall 动画*
- [x] 任意发声快速重来 — *中断后保持检测器运行，检测到元音自动 restart*

### 资源包系统（story 外增强）

- [x] `public/resources/` 资源包发现 (`index.json` + `manifest.json`)
- [x] 音节加载与解码 (`AudioBuffer`)
- [x] 帧图片加载（idle + animation frames）
- [x] 音节播放（可叠加）
- [x] 帧动画同步（rAF + EMA 速度平滑）
- [x] 资源包选择器 UI
- [x] 加载进度条

### 自由模式

- [x] `FreeModeConfig` 类型定义
- [x] 锁定阶段逻辑
- [x] 禁用中断逻辑
- [x] 任意元音模式逻辑
- [ ] 自由模式 UI 面板（设置按钮 + 参数滑块）
- [ ] 自定义旋转速度覆盖 — *字段已有，GameView 未读取*
- [ ] 自定义特效强度覆盖 — *字段已有，无渲染代码读取*
- [ ] 静音阈值调节 UI

### 分享系统

- [x] `sharing` 状态机状态
- [x] 分享状态 UI 渲染 — *结算卡片内嵌分享预览，牌堆式倾斜展示图片/视频，长按或右键保存*
- [x] 截图生成（分数 + 二维码 + 文案） — *Canvas 2D 绘制精美分享卡，含阶段进度条、装饰性 QR、多变种趣味文案*
- [x] 视频录制（MediaRecorder，最后 15-30s） — *循环缓冲录制，游戏时自动启动，中断后即刻预览 WebM*
- [ ] 排行榜前端 UI
- [ ] 排行榜后端 (Cloudflare Workers KV)
- [ ] 自定义 BGM 模式（上传 + BPM 检测）

### 彩蛋系统

- [ ] 惨叫/尖叫 → 土拨鼠
- [ ] 打嗝/咳嗽 → 猫弹飞
- [ ] 吹口哨 → 猫摇摆
- [ ] 静默 10s → 猫睡觉
- [ ] 连续错误 → 困惑表情

### 成就系统

- [ ] 成就类型定义 (`achievements.ts`)
- [ ] 🏅 午夜猫叫 (00:00-06:00)
- [ ] 🏅 完美主义者 (100 连击不出错)
- [ ] 🏅 速度之猫 (<200ms 均间隔持续 30s)
- [ ] 🏅 马拉松选手 (单局 >5min)
- [ ] 🏅 社交达猫 (分享)

### 其他

- [x] 响应式布局（横屏 PC + 竖屏 Mobile）
- [ ] 键盘演示模式（无麦克风时）
- [ ] Web Worker 音频处理（当前主线程）
- [ ] iOS Safari 兼容性适配
